<VirtualHost *:80>
    ServerName  domain
    ServerSignature Off
  
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), fullscreen=(self)"
    
  
    Header edit Set-Cookie ^(PM-TabPrimary.*)$ $1;HttpOnly;Secure;SameSite=Strict
    Header edit Set-Cookie ^(PM-Warning.*)$ $1;HttpOnly;Secure;SameSite=Strict
    
  
    Header unset Server
    Header unset X-Powered-By

    DocumentRoot /opt/processmaker/workflow/public_html
    DirectoryIndex index.php

    <Directory /opt/processmaker/workflow/public_html>
        Options -Indexes +FollowSymLinks -ExecCGI -Includes
        AddDefaultCharset UTF-8
        AllowOverride None
        Require all granted

        ExpiresActive On
        ExpiresByType image/gif "access plus 1 day"
        ExpiresByType image/png "access plus 1 day"
        ExpiresByType image/jpeg "access plus 1 day"
        ExpiresByType text/css "access plus 1 day"
        ExpiresByType application/javascript "access plus 1 day"
        ExpiresByType text/javascript "access plus 1 day"
        ExpiresByType font/ttf "access plus 1 day"

        RedirectMatch "^/$" /sysworkflow/fa/modern/login/login

     
        <LimitExcept GET POST PUT>
            Require all denied
        </LimitExcept>

        <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css application/javascript application/json
        </IfModule>

       
        <IfModule mod_rewrite.c>
            RewriteEngine On

	    RewriteCond %{REQUEST_URI} setup/pluginsMain [NC]
            RewriteRule ^.*$ - [F,L]
            
            RewriteCond %{REQUEST_URI} setup/skinsList [NC]
            RewriteRule ^.*$ - [F,L]
            
         
            RewriteRule ^security-filter\.php$ - [F,L]
            
     
            RewriteRule \.(ini|conf|log|sql|bak|backup|old|orig|save|swp|tmp)$ - [F,L]
            RewriteRule ^(wp-config|config|database|\.env|\.htaccess|\.htpasswd)$ - [F,L]
            
         
            RewriteCond %{REQUEST_URI} !^(?i)/api/ [NC]
            RewriteCond %{QUERY_STRING} !^.*/(sysworkflow|workflow|jscore|extjs|gulliver|api|page|lib|plugins|engine|services|cases|processes|tasks|users|groups|roles|departments|calendar|reports|dashboard|designer|setup|admin|webentry|authentication|logout)/ [NC]
            RewriteCond %{QUERY_STRING} !(trigger|dynaform|cases|pmtable|grid|suggest|process|task|step|user|group|role|department|calendar|reports|dashboard|designer|setup|admin|webentry|authentication|logout|api|jscore|extjs|gulliver|workflow|execute-query|oauth2|ajax|data|proxy|json|xml|rest|service|ws|webservice|mobile|plugin|extension|integration|external|cron|scheduler) [NC]
            RewriteCond %{QUERY_STRING} (<script[^>]*>|javascript:\s*[^'"\s]*|vbscript:\s*[^'"\s]*|on(load|error|click|mouseover|focus|blur|change|submit)\s*=|eval\s*\(|expression\s*\(|alert\s*\(|confirm\s*\(|prompt\s*\(|\%3C[^>]*\%3E|"\s*on[a-z]+\s*=|<iframe|<object|<embed|<form|<img[^>]*onerror) [NC]
            RewriteRule .* - [F,L]
            
            # Block obvious SQL injection attempts with enhanced patterns
            RewriteCond %{REQUEST_URI} !^(?i)/api/ [NC]
            RewriteCond %{QUERY_STRING} !^.*/(sysworkflow|workflow|jscore|extjs|gulliver|api|page|lib|plugins|engine|services|cases|processes|tasks|users|groups|roles|departments|calendar|reports|dashboard|designer|setup|admin|webentry|authentication|logout)/ [NC]
            RewriteCond %{QUERY_STRING} !(trigger|dynaform|cases|pmtable|grid|suggest|process|task|step|user|group|role|department|calendar|reports|dashboard|designer|setup|admin|webentry|authentication|logout|api|jscore|extjs|gulliver|workflow|execute-query|oauth2|ajax|data|proxy|json|xml|rest|service|ws|webservice|mobile|plugin|extension|integration|external|cron|scheduler) [NC]
            RewriteCond %{QUERY_STRING} ((select|insert|update|delete|drop|create|alter|exec|union).*[;&].*--|sleep\s*\(|benchmark\s*\(|waitfor\s+delay|load_file\s*\(|into\s+(outfile|dumpfile)|%27.*OR.*%271%27\s*=\s*%271%27|['"]?\s*OR\s*1\s*=\s*1\s*--|0x[0-9A-Fa-f]+|char\s*\(|concat\s*\(|group_concat\s*\() [NC]
            RewriteRule .* - [F,L]
            
          
            RewriteCond %{QUERY_STRING} (\.\.\/|\.\.\\|php://input|php://filter|file://|ftp://|data://|expect://|zip://|compress\.bzip2://|compress\.zlib://|glob://) [NC]
            RewriteRule .* - [F,L]
            
          
            RewriteCond %{QUERY_STRING} (\x00|\%00|\\x00|\\0|null) [NC]
            RewriteRule .* - [F,L]
            
        
            RewriteCond %{QUERY_STRING} (;|\||\`|\$\(|&&|\|\||<\(|>\() [NC]
            RewriteRule .* - [F,L]
            
         
            RewriteCond %{QUERY_STRING} (https?://|ftp://|sftp://|ftps://) [NC]
            RewriteRule .* - [F,L]
            
        
            RewriteCond %{QUERY_STRING} (base64_encode|base64_decode) [NC]
            RewriteRule .* - [F,L]
            
         
            RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
            
           
            RewriteCond %{REQUEST_URI} ^/csp-report$
            RewriteRule ^ csp-report.php [L,NC]
            
            
            RewriteCond %{REQUEST_URI} ^/page/app
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule ^(.*)$ /page/app/index.html [L]
            
          
            RewriteCond %{REQUEST_FILENAME} -f
            RewriteRule ^ - [L] 
            
          
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule ^(.*)$ app.php [QSA,L]
        </IfModule>

      
        LimitRequestBody 20971520
        
      
        <IfModule mod_evasive24.c>
            DOSHashTableSize    2048
            DOSPageCount        2
            DOSSiteCount        50
            DOSPageInterval     1
            DOSSiteInterval     1
            DOSBlockingPeriod   60
        </IfModule>
    </Directory>

     
    <Directory /opt/processmaker/workflow/public_html/files>
        Options -Indexes -ExecCGI -Includes -FollowSymLinks
        AllowOverride None
        <FilesMatch "\.php$">
            Require all denied
        </FilesMatch>
        <FilesMatch "\.(exe|sh|bat|cmd|com|scr|vbs|js|jar|pif)$">
            Require all denied
        </FilesMatch>
    </Directory>

    
    <Directory /opt/processmaker/workflow/public_html/gulliver>
        Options -Indexes -ExecCGI -Includes
        <FilesMatch "^(config|database|env)\.php$">
            Require ip 127.0.0.1
            Require ip ::1
        </FilesMatch>
        <FilesMatch "\.php$">
            Require all granted
        </FilesMatch>
    </Directory>

  
    <Directory /opt/processmaker/workflow/public_html/engine>
        Options -Indexes -ExecCGI -Includes
        <FilesMatch "^(config|database|env)\.php$">
            Require ip 127.0.0.1
            Require ip ::1
        </FilesMatch>
        <FilesMatch "\.php$">
            Require all granted
        </FilesMatch>
    </Directory>

 
    <Directory /opt/processmaker/workflow/public_html/page/app>
        DirectoryIndex disabled
        Options -Indexes -ExecCGI -Includes
    </Directory>

    # Prevent access to .htaccess and sensitive files
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>
    
 
    <FilesMatch "\.(bak|backup|old|orig|save|swp|tmp|log|ini|conf|sql)$">
        Require all denied
    </FilesMatch>

  
    <DirectoryMatch "^/.*/\.(git|svn|hg|bzr|cvs)/">
        Require all denied
    </DirectoryMatch>

   
    <FilesMatch "\.php$">
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-Frame-Options "SAMEORIGIN"
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        # Remove PHP version information
        Header unset X-Powered-By
    </FilesMatch>

    
    ErrorLog /var/log/apache2/domain.error.log
    CustomLog /var/log/apache2/domain.access.log combined

    
    LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" \"%{X-Forwarded-For}i\" \"%{X-Real-IP}i\" %D" security
    CustomLog /var/log/apache2/domain.security.log security
    
   
    <IfModule mod_rewrite.c>
        LogLevel warn rewrite:trace2
    </IfModule>

</VirtualHost>
